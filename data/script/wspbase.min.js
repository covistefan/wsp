var pLog = false;
var cT = 3600000;

function sQ(f, b, m) {
    var sl = $('#'+f).val().length;
    console.log(f + ':' + b + ':' + m + ':' + sl);
    $('#show_' + f + '_length').text(sl);
    $('#' + f).removeClass('form-control-warning').removeClass('form-control-success').removeClass('form-control-danger').removeClass('form-control-info');
    if (sl <= (b / 4)) {
        $('#' + f).addClass('form-control-danger');
    } else if (sl <= (b / 4 * 3)) {
        $('#' + f).addClass('form-control-warning');
    } else if (sl <= b) {
        $('#' + f).addClass('form-control-success');
    } else if (sl <= b + ((m - b) / 3)) {
        $('#' + f).addClass('form-control-info');
    } else if (sl <= b + ((m - b) / 3 * 2)) {
        $('#' + f).addClass('form-control-warning');
    } else {
        $('#' + f).addClass('form-control-danger');
    }
}

function showPageQuality(fieldname, bestlength, maxlength, sitelength) {
    var stringlength = document.getElementById(fieldname).value.length;
    if (fieldname == 'pagekeys') {
        stringlength = stringlength + sitelength
    }
    if (stringlength < 1) {
        stringlength = sitelength
    };
    var qualstat = 1;
    document.getElementById('show_' + fieldname + '_length').innerHTML = stringlength;
    if (stringlength <= (bestlength / 4)) {
        $('#' + fieldname).css('background-color', '#DA5358');
    } else if (stringlength <= (bestlength / 4 * 3)) {
        $('#' + fieldname).css('background-color', '#FEE1B0');
    } else if (stringlength <= bestlength) {
        $('#' + fieldname).css('background-color', '#7DB83A');
    } else if (stringlength <= bestlength + ((maxlength - bestlength) / 3)) {
        $('#' + fieldname).css('background-color', '#7DB83A');
    } else if (stringlength <= bestlength + ((maxlength - bestlength) / 3 * 2)) {
        $('#' + fieldname).css('background-color', '#FEE1B0');
    } else {
        $('#' + fieldname).css('background-color', '#DA5358');
    }
}

function passHeight(pe, ce, cn, ca, tc) {
    var bcs = new Array();
    var boxSum = 0;
    var i = 0;
    var boxCount = 0;
    var mch = 0;
    var bc = 0;
    var wc = new Array();
    $(pe).each(function() {
        $(this).children(ce).each(function() {
            i++;
            $(this).addClass(tc + i);
            for (var a = 0; a < ca.length; ++a) {
                if ($(this).hasClass(ca[a])) {
                    bcs[i] = (a + 1);
                }
            }
        });
    });
    for (var b = 1; b < bcs.length; ++b) {
        bc = bc + bcs[b];
        $('.' + tc + b).height('auto');
        if ($('.' + tc + b).height() > mch) {
            mch = $('.' + tc + b).height();
        }
        wc.push('.' + tc + b);
        if (bc >= cn) {
            for (var w = 0; w < wc.length; w++) {
                $(wc[w]).css('height', mch);
            }
            bc = 0;
            mch = 0;
            wc = new Array();
        }
    }
}

function updateQueue(qval) {
    if ((qval * 1) > 0) {
        $('span.queue-num-badge').text(qval).show();
    } else {
        $('span.queue-num-badge').text('0').hide();
    }
}

function updatePublish(msgTxt) {
    alert(msgTxt);
}

function removeQueue(qval) {
    console.info('remove row ' + qval);
    $('#queuerow-' + qval).hide(500);
}

function addPMsg(msgTxt) {
    $('#publishoutput').text($('#publishoutput').text() + msgTxt + "\n");
}

function backgroundPublish(publishNum) {
    if (pLog === true) {
        $('#publishoutput').text($('#publishoutput').text() + 'bP called ' + formatDate() + ' ' + formatTime() + "\n");
    }
    $('body').append('<form action="./xajax/iframe.publisherreact.php" method="post" target="publisherpost" id="iframepost"></form>');
    $('#iframepost').append('<input type="hidden" name="qn" value="' + parseInt(cT) + '" />');
    $('#iframepost').append('<input type="hidden" name="log" value="' + ((pLog === true) ? 'true' : 'false') + '" />');
    $('#iframepost').append('<input type="hidden" name="bp" value="true" />');
    $('#iframepost').submit().remove();
}

function callBackgroundPublish() {
    $.post("./xajax/ajax.publisherinfo.php").done(function(data) {
        if (parseInt(data) > 0) {
            nC = new Date(Date.now() + parseInt(data));
            console.info('next Call: ' + nC.getFullYear() + '-' + ('0' + (nC.getMonth()+1)).substr(-2) + '-' + ('0' + nC.getDate()).substr(-2) + ' ' + ('0' + nC.getHours()).substr(-2) + ':' + ('0' + nC.getMinutes()).substr(-2) + ':' + ('0' + nC.getSeconds()).substr(-2))
            backgroundPublish(parseInt(data));
            cT = parseInt(data);
        } else {
            // no session avaiable
            // quit wsp
            window.location.replace('./logout.php');
        }
    });
    setTimeout('callBackgroundPublish();', cT);
}

function doReLogin(doLog) {
    $.post("./xajax/ajax.unlockscreen.php", {
        'repass': $('#repass').val(),
        'reuser': $('#reuser').val()
    }).done(function(data) {
        // if (doLog == 1) {
            console.log(data);
        // }
        if (data == 'true') {
            $('body').removeClass('lockscreen');
            $('#wrapper').removeClass('lockscreen');
            $('#lockscreen').hide().html('');
            //          $('#repass').val('');
            $('#cfc').val(0);
        } else {
            var loginW = $('.auth-box.lockscreen').outerWidth();
            var screenW = $('#lockscreenbg').outerWidth();
            var marginW = Math.ceil((screenW - loginW) / 2);
            var marginW = marginW - 30;
            for (s = 1; s < 12; s++) {
                $('.auth-box.lockscreen').animate({
                    'margin-left': (marginW + (30 * (s % 2))) + 'px'
                }, 100);
            }
        }
    });
}

function showReLogin(doLog) {
    $.post("./xajax/ajax.lockscreen.php").done(function(data) {
        if (data != '') {
            $('body').addClass('lockscreen');
            $('#wrapper').addClass('lockscreen');
            $('#lockscreen').append(data).fadeIn(1000);
            $('#cfc').val(1);
        }
    });
}

function formatDate(date) {
    if (date === undefined) {
        date = new Date();
    }
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();
    if (month.length < 2)
        month = '0' + month;
    if (day.length < 2)
        day = '0' + day;
    return [year, month, day].join('-');
}

function formatTime(date) {
    if (date === undefined) {
        date = new Date();
    }
    var d = new Date(date),
        hour = '' + (d.getHours() + 1),
        min = '' + d.getMinutes(),
        sec = '' + d.getSeconds();
    if (hour.length < 2)
        hour = '0' + hour;
    if (min.length < 2)
        min = '0' + min;
    if (sec.length < 2)
        sec = '0' + sec;
    return [hour, min, sec].join(':');
}

$(function() {
    $('table.table').each(function(index, elem) {
        var wid = $(this).css('width');
        var maxwid = $(this).css('max-width');
        $(this).css('width', 'auto');
        $(this).css('max-width', '9999%');
        if ($(this).width() > $(this).parents('div').innerWidth()) {
            var tbl = document.createElement('table');
            tbl.setAttribute('class', 'table');
            var col = new Array();
            var thc = $(this).children('thead').children('tr').children();
            thc.each(function(thindex, thelem) {
                col[thindex] = $(this);
            });
            var tb = $(this).children('tbody').children('tr');
            tb.each(function(tbindex, tbelem) {
                tbdy = document.createElement('tbody');
                tbdy.setAttribute('id', $(this).attr('id'));
                tdelem = $(this).children();
                tdelem.each(function(tdindex, tdselem) {
                    tr = document.createElement('tr');
                    td = document.createElement('td');
                    td.innerHTML = col[tdindex].html();
                    tr.append(td);
                    tr.append(tdselem);
                    tbdy.append(tr);
                });
                tbl.append(tbdy);
            });
            $(this).replaceWith(tbl);
        }
        $(this).css('min-width', '100%');
        $(this).css('max-width', maxwid);
    });
});

// changing panel system logic for .btn-toggle-collapse
$(document).ready(function() {
    var affectedElement = $('.panel-body');
    $('.panel .btn-toggle-panel').on('click', function(e) {
        e.preventDefault();
        // if has scroll
        if ($(this).parents('.panel').find('.slimScrollDiv').length > 0) {
            affectedElement = $('.slimScrollDiv');
        }
        if ($(this).find('i').hasClass('fa-plus')) {
            $(this).parents('.panel').find(affectedElement).slideDown(300);
            $(this).find('i').toggleClass('fa-plus fa-minus');
            $.post("./xajax/ajax.panelopener.php", {
                'panel': $(this).parents('.panel').attr('id'),
                'stat': 1
            });
        } else {
            $(this).parents('.panel').find(affectedElement).slideUp(300);
            $(this).find('i').toggleClass('fa-minus fa-plus');
            $.post("./xajax/ajax.panelopener.php", {
                'panel': $(this).parents('.panel').attr('id'),
                'stat': 0
            });
        }
    });

    $('#publisherpost').attr('src', './xajax/iframe.publisherpost.php');

    $('i.fa-btn').each(function() {
        $(this).css('min-width', $(this).outerHeight()).css('text-align', 'center');
    });

    $("#alert-holder").fadeIn(1000);

});

$(function() {
    $('.medialist .toggle-medialist').on('click', function() {
        $(this).parent('li').toggleClass('collapsed');
    })
});

// checking for JSON-data
function IsJsonString(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
}

// extending jquery to allow tabs in 

(function($) {
    function pasteIntoInput(el, text) {
        el.focus();
        var val = el.value;
        if (typeof el.selectionStart == "number") {
            var selStart = el.selectionStart;
            el.value = val.slice(0, selStart) + text + val.slice(el.selectionEnd);
            el.selectionEnd = el.selectionStart = selStart + text.length;
        } else if (typeof document.selection != "undefined") {
            var textRange = document.selection.createRange();
            textRange.text = text;
            textRange.collapse(false);
            textRange.select();
        }
    }

    function allowTabChar(el) {
        $(el).keydown(function(e) {
            if (e.which == 9) {
                pasteIntoInput(this, "\t");
                return false;
            }
        });
        $(el).keypress(function(e) {
            if (e.which == 9) {
                return false;
            }
        });
    }
    $.fn.allowTabChar = function() {
        if (this.jquery) {
            this.each(function() {
                if (this.nodeType == 1) {
                    var nodeName = this.nodeName.toLowerCase();
                    if (nodeName == "textarea" || (nodeName == "input" && this.type == "text")) {
                        allowTabChar(this);
                    }
                }
            })
        }
        return this;
    }
})(jQuery);